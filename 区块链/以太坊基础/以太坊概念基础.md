## 以太坊概念基础
现行法律的本质是一种合约。它是由（生活于某一社群的）人和他们的领导者之间所缔结的，一种关于彼此该如何行动的共识。个体之间也存在着一些合约，这些合约可以理解为一种私法，相应的，这种私法仅对合约的参与者生效。

我们已经知道了法律就是一种合约，然而，一直以来，现行的法律体系都存在着两个巨大的问题：
 1. 合约或法律是由充满歧义的语句定义的
 2. 强制执行合约或法律的代价非常大。

以太坊，**通过数字货币和编程语言的结合**，解决了现行法律体系的这两大问题。

以太坊采用区块链的原理，又增加了在区块链上创建智能合约：智能合约是一种应用，它能保存价值，存储数据，封装代码，执行计算任务。类似比特币，以太坊也含有货币，称为以太(ether)。以太是计算机节点挖出来的，由节点验证交易，交易存储在分布共识的区块链中。以太可以在账户(公钥)之间以及智能合约之间转移。

在对比特币的机制有一定了解的基础上，我们来看看以太坊的设计原则。

### 区块链层协议
本节对以太坊中区块链层协议的改变进行了描述，包括区块和交易是如何工作的、数据如何序列化及存储、账户背后的机制。

#### 使用账户而非UTXO
比特币及其许多衍生品，都将用户的余额信息存储在UTXO结构中，系统的整个状态由一系列的“有效的输出”组成（可以将这些“有效的输出”想象成钱币）。每个UTXO都有拥有者和自身的价值属性。一笔交易在消费若干个UTXO同时也会生成若干个新的UTXO。

“有效的输出”中有效需满足下面几点约束：

1. 每个被引用的输入必须有效，且未被使用过；
2. 交易的签名必须与每笔输入的所有者签名匹配；
3. 输入的总值必须等于或大于输出的总值。

但是，**以太坊抛弃了UTXO的方案**，转而使用更简单的方法：**采用状态(state)的概念存储一系列账户**，每个账户都有自己的余额，以及以太坊特有的数据（代码或内部存储器）。如果交易发起方的账户余额足够支付交易费用，则交易有效，那么发起方账户会扣除相应金额，而接受账户则计入该金额。

某些情况下，接受账户内有需要执行的代码，则交易会触发该代码的执行，那么账户的内部存储器可能就会发生变化，甚至可能会创建额外的信息发送给其他账户，从而导致新的交易发生。

##### UTXO vs 账户

UTXO有以下优点：

1. **较高程度的隐私保护**，如果用户每次交易都使用一个新的地址，那么账户之间的相互关联就很困难。这样做适用于对安全性要求高的货币系统，但对任何dapp应用来说就不合适了。因为dapp通常需要跟踪用户复杂的绑定状态，而dapp的状态并不能像货币系统中的状态那样简单地划分。

2. **潜在地可扩展性**，UTXO在理论上可扩展性更好。因为我们只能依靠那些金融货币拥有者来维护能够证明货币所有权的默克尔树，即使所有的人(包括数据的拥有者)都遗忘了某一数据，真正受损也只有数据的拥有者，其他人不受影响。

账户的优点：

1. **节省大量空间**，不需要存储太多的UTXO，只需要存储一个账户地址。

2. **可替代性更高**，在UTXO结构中，“有效输出”的源码实现中没有区块链层的概念，所以不管是在技术还是法律上，通过建立一个红名单/黑名单，并依据的这些“有效输出”的来源区分它们并不是很实际。

3. **简单**，以太坊编码更简单、更易于理解

4. **轻客户端**，轻客户端可以随时通过沿指定方向扫描状态树来访问与账户相关的所有数据。在UTXO方式中，引用随着每个交易的变化而变化，这对于长时间运行并使用了上文提到的UTXO根状态传播机制的dapp应用来说，无疑是繁重的。


#### 以太坊账户
以太币（Ether）是以太坊内部的主要加密燃料，用于支付交易费用。一般而言，**以太坊有两种类型的账户：外部所有的账户**（由私钥控制的）和合约账户（由合约代码控制）。外部所有的账户没有代码，人们可以通过创建和签名一笔交易从一个外部账户发送消息。每当合约账户收到一条消息，合约内部的代码就会被激活，允许它对内部存储进行读取和写入，和发送其它消息或者创建合约。

就是简单理解为，就是两种账户：

![](image/eth0.png)

一种外部账户，就是普通账户。一种是合约账户，合约账户允许外部账户向其发消息，从外部拥有账户到合约账户的消息会激活合约账户的代码，允许它执行各种动作。（比如转移代币，写入内部存储，挖出一个新代币，执行一些运算，创建一个新的合约等等）。

**合约账户不可以自己发起一个交易。相反，合约账户只有在接收到一个交易之后(从一个外部拥有账户或另一个合约账户接)，为了响应此交易而触发一个交易。**

![](image/eth1.png)

以太坊的账户包含四个部分，**不论账户类型是什么，都存在这四个组成部分**：

 - 随机数nonce：如果账户是一个外部拥有账户，nonce代表从此账户地址发送的交易序号。如果账户是一个合约账户，nonce代表此账户创建的合约序号

 - 余额balance： 此地址拥有Wei的数量。1Ether=10^18Wei

 - storageRoot： Merkle Patricia树的根节点Hash值。Merkle树会将此账户存储内容的Hash值进行编码，默认是空值

 - codeHash：此账户EVM（以太坊虚拟机）代码的hash值。对于合约账户，就是被Hash的代码并作为codeHash保存。对于外部拥有账户，codeHash域是一个空字符串的Hash值

 ![](image/eth2.png)

#### 消息和交易
以太坊的消息在某种程度上类似于比特币的交易，但是两者之间存在三点重要的不同

1. 以太坊的消息可以由 **外部实体或者合约** 创建，然而比特币的交易只能从外部创建。
2. 以太坊消息可以选择包含数据
3. 如果以太坊消息的接受者是合约账户，可以选择进行回应，这意味着以太坊消息也包含函数概念。

### 状态与Merkle树
以太坊全局需要维护账户以及对应的账户状态。这跟比特币不同，比特币需要维护的，是全局每个交易，及对应的交易状态。而以太坊的链，直接要保存账户状态信息。

我们在密码学基础笔记里已经提到过Merkle树

![](image/eth3.png)

一系列的中间的节点，这些节点是两个子节点的Hash值。而 **叶子节点里存储的，就是账户状态**。bitcoin里，Merkle树维护的是交易状态，而这里是直接维护账号状态。叶子节点对应的都是每个账户，包括每个账户的balance, nonce, codeHash和storageRoot（storageRoot自己就是一颗树）。

![](image/eth4.png)

### 参考
[干货 | 以太坊设计原理](https://ethfans.org/posts/510)

[以太坊学习](https://www.jianshu.com/p/220130b39e22)

[以太坊白皮书](https://ethfans.org/wikis/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%99%BD%E7%9A%AE%E4%B9%A6)

[详解以太坊的工作原理](https://www.8btc.com/article/142319)
